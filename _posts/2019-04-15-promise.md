---
layout:     post
title:      Promiseä½ çœŸçš„äº†è§£å—ï¼Ÿ
subtitle:    "\"Promiseæ±‚é’ˆå¯¹\""
date:       2019-04-22
author:     Booleen
header-img: img/post-bg-e2e-ux.jpg
catalog: true
tags:
    - JavaScript
    - ES6
---

> â€œ æ¯å¤©éƒ½è¦è¿›æ­¥å•Š â€


## èƒŒæ™¯

è¿‡äº†é‚£æ®µåªåšç»ƒä¹ é¡¹ç›®çš„æ—¶å…‰ï¼Œäººæ€»æ˜¯è¦æˆé•¿çš„ã€‚è¿‘æ®µæ—¶é—´å¼€å‘ä¸šåŠ¡åæ€è‡ªå·±ä¸€å¤©å¤©çš„æ—¶å…‰éƒ½èŠ±åœ¨å“ªå„¿äº†ï¼Œå¥½åƒä¸æ˜¯åœ¨æ‹§èºä¸ï¼Œå°±æ˜¯åœ¨è§£å†³bugã€‚åœ¨æ‹§èºä¸è¿‡ç¨‹ä¸­å‘ç°å¯¹promiseå¯¹è±¡ä¸æ˜¯å¾ˆäº†è§£ï¼Œæ‰€ä»¥å°±æ‰“ç®—å¹¶æ ¹æ®è‡ªå·±çš„ç»éªŒç»“åˆå¤§ä½¬ä»¬çš„æ•™ç¨‹å¥½å¥½å­¦ä¹ ä¸€æŠŠã€‚

## å«ä¹‰

æ–°æ‰‹ä¼šé—®ï¼šä»€ä¹ˆæ˜¯Promise?

```
Promiseæ˜¯JSå¼‚æ­¥ç¼–ç¨‹ä¸­çš„é‡è¦æ¦‚å¿µï¼Œå¼‚æ­¥æŠ½è±¡å¤„ç†å¯¹è±¡ï¼Œä¸€èˆ¬ç”¨äºå¤„ç†å¼‚æ­¥ç¼–ç¨‹ã€‚
ï¼ˆES6 å°†å…¶å†™è¿›äº†è¯­è¨€æ ‡å‡†ï¼Œç»Ÿä¸€äº†ç”¨æ³•ï¼ŒåŸç”Ÿæä¾›äº†`Promise`å¯¹è±¡ï¼‰

```

 ç®€å•è€Œè¨€ä¹‹ **ï¼šä¸€ä¸ªä¿å­˜ç€æŸä¸ªæœªæ¥æ‰ä¼šç»“æŸçš„äº‹ä»¶ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼‰çš„ç»“æœçš„**å®¹å™¨(ç”¨æ¥é¢„å®šä¸€ä¸ªä¸ä¸€å®šèƒ½å®Œæˆçš„ä»»åŠ¡ï¼Œè¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥) ã€‚

## å‡ºç°çš„åŸå› 

åœ¨æˆ‘ä»¬å¼€å‘é¡¹ç›®çš„æ—¶å€™æ—¶å¸¸ä¼šé‡åˆ°è°ƒç”¨å¼‚æ­¥è¯·æ±‚ï¼Œå½“åªè¦ä¸€ä¸ªè¯·æ±‚å°±å¯ä»¥è§£å†³çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå¹²ï¼š
```javascript
request(function(result){
    deal result
})
```

çœ‹èµ·æ¥è¿˜ä¸é”™ï¼

ä½†æ˜¯å¾€å¾€éœ€æ±‚ä¸ä¼šå¦‚ä½ æ‰€æ„¿ï¼Œæ¯”å¦‚å‡ºç°å¦‚ä¸‹æƒ…å†µï¼š
```
request1(function(result1){
    deal result1
    request2(function(result2){
        deal result2
        request3(function(result3){
            deal result3
            ...
        })
    })
})
```
å¦‚æœåœ¨ä¸€ä¸ªè¯·æ±‚å‡ºé”™äº†ï¼Œè¯¥å’‹åŠï¼ï¼ï¼è¿™å°±æ˜¯å¯æ€•çš„**å›è°ƒåœ°ç‹±**ã€‚
ç¡®å®ä½ è¿™æ ·åšå®ç°äº†åŠŸèƒ½ï¼Œå½“æœ‰éœ€æ±‚å˜æ›´æˆ–è€…åç»­ç»´æŠ¤ï¼Œé‚£å°±æ˜¯ä»¶ææ€–äº‹ä»¶ï¼

è¯´è¯´å›è°ƒå‡½æ•°ï¼š
```
// ä»¥æ­¤å‡½æ•°å¨ä¸ºä¾‹ï¼Œ
setTimeout(function () {
  console.log('callback...');
}, 1000);
// 1.æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å‡½æ•°
// 2.æˆ‘ä»¬è‡ªå·±æ²¡æœ‰å»æ‰§è¡Œçš„
// 3.ç”±å…¶ä»–äºº(æ¯”å¦‚ï¼šæµè§ˆå™¨çš„ajaxæ¨¡å—ã€å®šæ—¶å™¨æ¨¡å—)æ‰§è¡Œäº†
```

é‚£ä¹ˆå›è°ƒåœ°ç‹±ï¼šæ¯ä¸€å±‚çš„å›è°ƒå‡½æ•°éƒ½éœ€è¦ä¾èµ–ä¸Šä¸€å±‚çš„å›è°ƒæ‰§è¡Œå®Œï¼Œæ‰€ä»¥å½¢æˆäº†å±‚å±‚åµŒå¥—çš„å…³ç³»æœ€ç»ˆå½¢æˆç±»ä¼¼ä¸Šé¢çš„å›è°ƒåœ°ç‹±ã€‚

å›è°ƒåœ°ç‹±çš„ç—›ç‚¹ï¼š
- ä»£ç è‡ƒè‚¿ï¼Œå¯è¯»æ€§å·®
- ä»£ç ä¸å¯å¤ç”¨
- å¼‚å¸¸å¤„ç†éº»çƒ¦

é‚£ä¹ˆï¼Œæ€»ä¼šæœ‰é‚£ä¹ˆäº›ç‰›æ°äººç‰©ä¼šæƒ³åˆ°ç›¸åº”çš„è§£å†³åŠæ³•ï¼Œæ¯”å¦‚æŠŠè¿™äº›è¯·æ±‚ç»“æœä¸€å±‚å±‚è§£è€¦ï¼Œä¸€æ­¥æ­¥å¤„ç†é—®é¢˜ã€‚
```javascript
let res1 = request1();
let res2 = request2(res1); 
let res3 = request3(res2); 
let res4 = request4(res3); 
let res5 = request5(res4); 
...
```

äºæ˜¯Promiseè¯ç”Ÿäº†ï¼Œåœ¨ä¸šç•Œä¹Ÿæœ‰äº†å¾ˆå¤šå®ç°æ¥è§£å†³å›è°ƒåœ°ç‹±çš„ç—›ç‚¹ã€‚æ¯”å¦‚ä¸šç•Œè‘—åçš„ Q å’Œ bluebirdï¼Œbluebird ç”šè‡³å·ç§°è¿è¡Œæœ€å¿«çš„ç±»åº“ã€‚

promiseçš„å¸¸è§„å†™æ³•ï¼š
```JavaScript
new Promise(request1)
    .then(request2(res1))
    .then(request3(res2))
    .then(request4(res3))
    .then(request5(res4))
    .catch(error(throw error))
```

## promiseåŸºç¡€ç”¨æ³•åŠAPIï¼š
```JavaScript
var p = new Promise(function(resolve, reject) {
	// Do an async task async task and then...
	if(/* good condition */) {
		resolve('Success!');
	}
	else {
		reject('Failure!');
	}
});

// use promise
p.then(function(res) { 
	/* do something with the result */
}).catch(function(error) {
	/* error ğŸ™ */
})
```

å·®ä¸å¤špromiseçš„åŸºç¡€apiéƒ½åœ¨ä¸Šé¢ä»£ç é‡Œäº†ï¼Œ 

- Promise.resolve(value):è¿”å›promiseå¯¹è±¡çš„çŠ¶æ€ä¸ºresolve
```
ç±»æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªä»¥ value å€¼è§£æåçš„ Promise å¯¹è±¡
1ã€å¦‚æœè¿™ä¸ªå€¼æ˜¯ä¸ª thenableï¼ˆå³å¸¦æœ‰ then æ–¹æ³•ï¼‰ï¼Œè¿”å›çš„ Promise å¯¹è±¡ä¼šâ€œè·Ÿéšâ€è¿™ä¸ª thenable çš„å¯¹è±¡ï¼Œé‡‡ç”¨å®ƒçš„æœ€ç»ˆçŠ¶æ€ï¼ˆæŒ‡ resolved/rejected/pending/settledï¼‰
2ã€å¦‚æœä¼ å…¥çš„ value æœ¬èº«å°±æ˜¯ Promise å¯¹è±¡ï¼Œåˆ™è¯¥å¯¹è±¡ä½œä¸º Promise.resolve æ–¹æ³•çš„è¿”å›å€¼è¿”å›ã€‚
3ã€å…¶ä»–æƒ…å†µä»¥è¯¥å€¼ä¸ºæˆåŠŸçŠ¶æ€è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚
```

- Promise.reject:è¿”å›promiseå¯¹è±¡çš„çŠ¶æ€ä¸ºreject
```
ç±»æ–¹æ³•ï¼Œä¸”ä¸ resolve å”¯ä¸€çš„ä¸åŒæ˜¯ï¼Œè¿”å›çš„ promise å¯¹è±¡çš„çŠ¶æ€ä¸º rejectedã€‚
```

- Promise.prototype.then 
```
å®ä¾‹æ–¹æ³•ï¼Œä¸º Promise æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå‡½æ•°å½¢å¼ï¼šfn(vlaue){}ï¼Œvalue æ˜¯ä¸Šä¸€ä¸ªä»»åŠ¡çš„è¿”å›ç»“æœï¼Œthen ä¸­çš„å‡½æ•°ä¸€å®šè¦ return ä¸€ä¸ªç»“æœæˆ–è€…ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ï¼Œæ‰å¯ä»¥è®©ä¹‹åçš„then å›è°ƒæ¥æ”¶ã€‚
```

- Promise.prototype.catch
```
å®ä¾‹æ–¹æ³•ï¼Œæ•è·å¼‚å¸¸ï¼Œå‡½æ•°å½¢å¼ï¼šfn(err){}, err æ˜¯ catch æ³¨å†Œ ä¹‹å‰çš„å›è°ƒæŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ã€‚
```

- Promise.race
```
ç±»æ–¹æ³•ï¼Œå¤šä¸ª Promise ä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œè¿”å›æœ€å…ˆæ‰§è¡Œç»“æŸçš„ Promise ä»»åŠ¡çš„ç»“æœï¼Œä¸ç®¡è¿™ä¸ª Promise ç»“æœæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚
```

- Promise.all
```
ç±»æ–¹æ³•ï¼Œå¤šä¸ª Promise ä»»åŠ¡åŒæ—¶æ‰§è¡Œã€‚
å¦‚æœå…¨éƒ¨æˆåŠŸæ‰§è¡Œï¼Œåˆ™ä»¥æ•°ç»„çš„æ–¹å¼è¿”å›æ‰€æœ‰ Promise ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚ å¦‚æœæœ‰ä¸€ä¸ª Promise ä»»åŠ¡ rejectedï¼Œåˆ™åªè¿”å› rejected ä»»åŠ¡çš„ç»“æœã€‚
```

## ç–‘é—®
æœ€è¿‘æˆ‘åœ¨ç®€ä¹¦ä¸Šçœ‹åˆ°è¿™ä¹ˆä¸€é“é¢˜ï¼š
```JavaScript
// ä¸‹é¢4ä¸ªpromisesæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ
var something =function(){ return new Promise((reslove)=>{
    reslove('something');
})};
var somethingelse = function(){ return new Promise((reslove)=>{
    reslove('else');
})};
//num 1
something().then(function(){
    return somethingelse();
})
//Promise {<resolved>: "else"}
//num 2
something().then(function(){
     somethingelse();
})
//Promise {<resolved>: undefined}
//num 3
something().then(somethingelse());
// Promise {<resolved>: "something"}
//num 4
something().then(somethingelse);
// Promise {<resolved>: "else"}
```

â€”â€” Booleen åè®°äº 2019.04
